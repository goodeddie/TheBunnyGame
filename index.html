<!DOCTYPE html>
<html>
	<head>
		<!--
		
		The Bunny Game

		Created by Allice, Eddie, Ngoc, John

		Special thanks to Batiste Bieler and contributors for Sprite.js and more

		-->
		<title>
			The Bunny Game
		</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		
		<script src="sprite.js"></script>
		<script src="lib/collision.js"></script>
		<script type="text/javascript">
		window.onload = function() {
		
			sjs.debug = true;
		
			var scene = sjs.Scene({w:320, h:320});
			var layer = scene.Layer("game_layer");
			scene.loadImages([
				'img/star.png',
				'img/Bunnyyyy.png',
				'img/Bunny.png'
				],
				function() {
					engine = new Engine(scene, layer);
					ticker = scene.Ticker(function() {
						engine.run();
					});
					engine.setTicker(ticker);
					ticker.run();
				});
			};
			
			function Engine(scene, layer) {
				var that = this;
				
				this.scene = scene;
				this.layer = layer;
				this.ticker = null;
				this.inputs = scene.Input();
				this.setTicker = function(ticker) {
					this.ticker = ticker;
				}
				
				this.jumpOn = true;
				this.gravity = .25;
				
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				var s = layer.Sprite('img/star.png');
				s.move(0, 0);
				s.update();
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				
				//////////////////////////////////////////////////////////////////
				//Create our hero                                               //
				//////////////////////////////////////////////////////////////////
				this.hero = this.scene.Sprite("img/Bunny.png", {
					"layer": this.layer,
					"x": 100,
					"y": 100,
					"w": 64,
					"h": 64,
					"angle": 0,
					"xv": 0,
					"yv": 0,
					"friction": 0.5
				});
				
				this.hero.direction = 1; //0 - up, 1 - right, 2 - down, 3 - left
				this.hero.hasLanded = false;
				this.hero.selected = true;
				
				this.hero.standingLeft = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.hero);
				this.hero.standingRight = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.hero);
				this.hero.walkingLeft = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.hero);
				this.hero.walkingRight = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.hero);
				this.hero.updateAll = function() {
					if(this.selected && that.inputs.keyboard.up && this.hasLanded) {
						this.hasLanded = false;
						this.setVelocity(this.xv, -3);
					}
					else{
						
					}
					if(this.selected && that.inputs.keyboard.down) {
						//this.direction = 2;
						//ny += 2;
					}
					else{
					
					}
					if(this.selected && that.inputs.keyboard.left) {
						this.direction = 3;
						this.walkingLeft.next();
						if(this.xv > -5) {
							this.addVelocity(-0.5, 0);
						}
					}
					else{
						if(this.xv < 0) {
							this.walkingLeft.next();
							this.addVelocity(this.friction, 0);
						}
					}
					if(this.selected && that.inputs.keyboard.right) {
						this.direction = 1;
						this.walkingRight.next();
						if(this.xv < 5) {
							this.addVelocity(0.5, 0);
						}
					}
					else{
						if(this.xv > 0) {
							this.walkingRight.next();
							this.addVelocity(this.friction * -1, 0);
						}
					}
					if(this.xv == 0) {
						if(this.direction == 3) {
							this.standingLeft.next();
						}
						else if(this.direction == 1) {
							this.standingRight.next();
						}
					}
					if(!(this.hasLanded)) {
						this.addVelocity(0, that.gravity);
					}
					
					//Out of bounds check
					if((this.xv < 0) && (this.x + this.xv) < 0) {
						this.setVelocity(0, this.yv);
						this.setX(0);
					}
					else if((this.xv > 0) && (((this.x + this.xv) + this.w) > this.layer.w)) {
						this.setVelocity(0, this.yv);
						this.setX(this.layer.w - this.w);
					}
					else{
						this.setX(this.x + this.xv);
					}
					if((this.yv > 0) && (((this.y + this.yv) + this.h) > this.layer.h)) {
						this.hasLanded = true;
						this.setVelocity(this.xv, 0);
						this.setY(this.layer.h - this.h);
					}
					else{
						this.setY(this.y + this.yv);
					}
					
					//this.offset(0,0);
					this.update();
				}
				
				//////////////////////////////////////////////////////////////////
				//Create our test hero                                          //
				//////////////////////////////////////////////////////////////////
				this.testHero = this.scene.Sprite("img/Bunny.png",{
					"layer": this.layer,
					"x": 150,
					"y": 100,
					"w": 64,
					"h": 64,
					"angle": 0,
					"xv": 0,
					"yv": 0,
					"friction": 0.1
				});
				
				this.testHero.direction = 1; //0 - up, 1 - right, 2 - down, 3 - left
				this.hero.hasLanded = false;
				this.testHero.selected = false;
				
				this.testHero.updateAll = function() {
					if(this.selected && that.inputs.keyboard.up && this.hasLanded) {
						this.hasLanded = false;
						this.setVelocity(this.xv, -5);
					}
					else{
						
					}
					if(this.selected && that.inputs.keyboard.left) {
						this.direction = 3;
						this.rotate(-0.1);
						if(this.xv > -5) {
							this.addVelocity(-0.5, 0);
						}
					}
					else if(this.selected && that.inputs.keyboard.right) {
						this.direction = 1;
						this.rotate(0.1);
						if(this.xv < 5) {
							this.addVelocity(0.5, 0);
						}
					}
					else {
						if(this.direction == 1) {
							if(this.xv > 0) {
								this.rotate(0.1);
								this.addVelocity(this.friction * -1, 0);
							}
							else {
								this.setVelocity(0, this.yv);
							}
						}
						else if(this.direction == 3) {
							if(this.xv < 0) {
								this.rotate(-0.1);
								this.addVelocity(this.friction, 0);
							}
							else {
								this.setVelocity(0, this.yv);
							}
						}
					}
					if(!(this.hasLanded)) {
						this.addVelocity(0, that.gravity);
					}
					
					//Out of bounds check
					if((this.xv < 0) && (this.x + this.xv) < 0) {
						this.setVelocity(0,this.yv);
						this.setX(0);
					}
					else if((this.xv > 0) && (((this.x + this.xv) + this.w) > this.layer.w)) {
						this.setVelocity(0,this.yv);
						this.setX(this.layer.w - this.w);
					}
					else{
						this.setX(this.x + this.xv);
					}
					if((this.yv > 0) && (((this.y + this.yv) + this.h) > this.layer.h)) {
						this.hasLanded = true;
						this.setVelocity(this.xv, 0);
						this.setY(this.layer.h - this.h);
					}
					else{
						this.setY(this.y + this.yv);
					}
					
					this.update();
				}
				
				//////////////////////////////////////////////////////////////////
				//Handle mouse click                                            //
				//////////////////////////////////////////////////////////////////
				
				scene.dom.onclick = function(e) {
					if(sjs.collision.isPointInImage(
						e.clientX - s.x - scene.dom.offsetLeft,
						e.clientY - s.y - scene.dom.offsetTop,
						s.w,
						s.h,
						s.img)
					) {
						alert("star touched");
					}
					
					if(sjs.collision.isPointInImage(
						e.clientX - that.hero.x - scene.dom.offsetLeft,
						e.clientY - that.hero.y - scene.dom.offsetTop,
						that.hero.w,
						that.hero.h,
						that.hero.img)
					) {
						that.hero.selected = true;
						that.testHero.selected = false;
					}
					
					if(sjs.collision.isPointInImage(
						e.clientX - that.testHero.x - scene.dom.offsetLeft,
						e.clientY - that.testHero.y - scene.dom.offsetTop,
						that.testHero.w,
						that.testHero.h,
						that.testHero.img)
					) {
						that.hero.selected = false;
						that.testHero.selected = true;
					}
				};
				
				//Create run method which will be called each time the
				//game loop runs.
				this.run = function() {
					this.hero.updateAll();
					this.testHero.updateAll();
				}
			}
	</script>
	</head>
	<body>
		Click on the bunny and press wasd or arrows
		<span id="debug"></span>
	</body>
</html>