<!DOCTYPE html>
<html>
	<head>
		<!--
		
		The Bunny Game

		Created by Allice, Eddie, Ngoc, John

		Special thanks to Batiste Bieler and contributors for Sprite.js and more
		
		All rights and permissions reserved to Che Chan.

		-->
		<title>
			The Bunny Game
		</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		
		<script src="sprite.js"></script>
		<script src="lib/collision.js"></script>
		<script type="text/javascript">
		window.onload = function() {
		
			sjs.debug = true;
		
			var scene = sjs.Scene({w:512, h:320});
			var layer = scene.Layer("game_layer");
			scene.loadImages([
				'img/test/star.png',
				'img/Bunnyyyy.png',
				'img/BIG_BUNNY.png',
				'img/BunnyVer1.000.png',
				'img/cat.png',
				'img/giraffe.png',
				'img/turtle.png',
				'img/Bunny.png',
				'img/AllyIcon01.png',
				'img/old_master.png',
				'img/old_master_big.png',
				],
				function() {
					engine = new Engine(scene, layer);
					ticker = scene.Ticker(function() {
						engine.run();
					});
					engine.setTicker(ticker);
					ticker.run();
				});
			};
			
			function Engine(scene, layer) {
				var that = this;
				
				this.scene = scene;
				this.layer = layer;
				this.ticker = null;
				this.inputs = scene.Input();
				this.setTicker = function(ticker) {
					this.ticker = ticker;
				}
				this.spriteList = [];
				this.gravity = 0.25;
				
				//////////////////////////////////////////////////////////////////
				//Create our player                                             //
				//////////////////////////////////////////////////////////////////
				this.player = this.scene.Sprite("img/BunnyVer1.000.png", {
					"layer": this.layer,
					"x": 100,
					"y": 100,
					"w": 64,
					"h": 64,
					"angle": 0,
					"xv": 0,
					"yv": 0,
					"rv": 0,
					"friction": 0.5
				});
				
				//Common properties
				this.player.isNPC = false;
				this.player.lastDirection = 1; //2 - left, 3 - right, 0 - up, 1 - down
				this.player.xDirection = 3; //2 - left, 3 - right
				this.player.yDirection = 1; //0 - up, 1 - down
				this.player.canRun = false;
				this.player.canRoll = false;
				this.player.constXv = 2;
				this.player.constYv = 2;
				this.player.maxXv = 5;
				this.player.maxYv = 5;
				this.player.maxRv = 0.1;
				this.player.xInc = 0.5;
				this.player.yInc = 0.5;
				this.player.xFriction = 0.5;
				this.player.yFriction = 0.5;
				this.player.canVertical = true;
				this.player.hasLanded = false;
				this.player.jumpVelocity = -2;
				
				//Player properties
				this.player.selected = true;
				
				this.player.standingLeft = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.player);
				this.player.standingRight = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.player);
				this.player.walkingLeft = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.player);
				this.player.walkingRight = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.player);
				
				this.player.moveLeft = function() {
					if(this.selected) {
						_moveLeft(this);
					}
				}
				this.player.moveRight = function() {
					if(this.selected) {
						_moveRight(this);
					}
				}
				this.player.moveUp = function() {
					if(this.selected) {
						_moveUp(this);
					}
				}
				this.player.moveDown = function() {
					if(this.selected) {
						_moveDown(this);
					}
				}
				
				this.spriteList.push(this.player);
				
				//////////////////////////////////////////////////////////////////
				//Create our test player                                        //
				//////////////////////////////////////////////////////////////////
				this.player2 = this.scene.Sprite("img/Bunny.png", {
					"layer": this.layer,
					"x": 150,
					"y": 100,
					"w": 64,
					"h": 64,
					"angle": 0,
					"xv": 0,
					"yv": 0,
					"rv": 0,
					"friction": 0.25
				});
				
				//Common properties
				this.player2.isNPC = false;
				this.player2.lastDirection = 1; //2 - left, 3 - right, 0 - up, 1 - down
				this.player2.xDirection = 3; //2 - left, 3 - right
				this.player2.yDirection = 1; //0 - up, 1 - down
				this.player2.canRun = true;
				this.player2.canRoll = true;
				this.player2.constXv = 2;
				this.player2.constYv = 2;
				this.player2.maxXv = 5;
				this.player2.maxYv = 5;
				this.player2.maxRv = 0.1;
				this.player2.xInc = 0.5;
				this.player2.yInc = 0.5;
				this.player2.xFriction = 0.25;
				this.player2.yFriction = 0.25;
				this.player2.canVertical = false;
				this.player2.hasLanded = false;
				this.player2.jumpVelocity = -2;
				
				//Player properties
				this.player2.selected = false;
				
				this.player2.standingLeft = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.player2);
				this.player2.standingRight = scene.Cycle([
					[0, 0, 5]
				]).addSprite(this.player2);
				this.player2.walkingLeft = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.player2);
				this.player2.walkingRight = scene.Cycle([
					[0, 0, 5],
					[64, 64, 5]
				]).addSprite(this.player2);
				
				this.player2.moveLeft = function() {
					if(this.selected) {
						_moveLeft(this);
					}
				}
				this.player2.moveRight = function() {
					if(this.selected) {
						_moveRight(this);
					}
				}
				this.player2.moveUp = function() {
					if(this.selected) {
						_jumpUp(this);
					}
				}
				this.player2.moveDown = function() {
					if(this.selected) {
						
					}
				}
				
				this.spriteList.push(this.player2);
				
				//////////////////////////////////////////////////////////////////
				//How to update movement                                        //
				//////////////////////////////////////////////////////////////////
				_updateMovement = function(sprite) {
					if(sprite.isNPC) {
						sprite.move();
					}
					else {
						if(that.inputs.keyboard.left) {
							sprite.moveLeft();
						}
						else if(that.inputs.keyboard.right) {
							sprite.moveRight();
						}
						else {
							if(sprite.xFriction != 0) {
								_applyFriction(sprite, 0);
							}
							
							//Update sprite
							if(sprite.xv == 0) {
								if(sprite.xDirection == 2) {
									sprite.standingLeft.next();
								}
								else if(sprite.xDirection == 3) {
									sprite.standingRight.next();
								}
							}
						}
						
						if(that.inputs.keyboard.up) {
							sprite.moveUp();
						}
						else if(that.inputs.keyboard.down) {
							sprite.moveDown();
						}
						else {
							if(sprite.canVertical) {
								if(sprite.yFriction != 0) {
									_applyFriction(sprite, 1);
								}
							}
						}
					}
					
					if(!(sprite.canVertical)) {
						_applyGravity(sprite);
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to generally move left                                    //
				//////////////////////////////////////////////////////////////////
				_moveLeft = function(sprite) {
					sprite.lastDirection = 2;
					sprite.xDirection = 2;
					sprite.walkingLeft.next();
					if(sprite.canRun) {
						if(sprite.canRoll) {
							if(sprite.rv > (sprite.maxRv * -1)) {
								sprite.rv = sprite.rv - 0.01;
							}
							sprite.rotate(sprite.rv);
						}
						else {
							sprite.setAngle(0);
						}
						if(sprite.xv > sprite.maxXv * -1) {
							sprite.addVelocity(sprite.xInc * -1, 0);
						}
					}
					else {
						sprite.xv = Math.abs(sprite.constXv) * -1;
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to generally move right                                   //
				//////////////////////////////////////////////////////////////////
				_moveRight = function(sprite) {
					sprite.lastDirection = 3;
					sprite.xDirection = 3;
					sprite.walkingRight.next();
					if(sprite.canRun) {
						if(sprite.canRoll) {
							if(sprite.rv < sprite.maxRv) {
								sprite.rv = sprite.rv + 0.01;
							}
							sprite.rotate(sprite.rv);
						}
						else {
							sprite.setAngle(0);
						}
						if(sprite.xv < sprite.maxXv) {
							sprite.addVelocity(sprite.xInc, 0);
						}
					}
					else {
						sprite.xv = Math.abs(sprite.constXv);
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to generally move up                                      //
				//////////////////////////////////////////////////////////////////
				_moveUp = function(sprite) {
					sprite.lastDirection = 0;
					sprite.yDirection = 0;
					//sprite.walkingUp.next();
					if(sprite.canRun) {
						if(sprite.yv > sprite.maxYv * -1) {
							sprite.addVelocity(0, sprite.yInc * -1);
						}
					}
					else {
						sprite.yv = Math.abs(sprite.constYv) * -1;
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to generally move down                                    //
				//////////////////////////////////////////////////////////////////
				_moveDown = function(sprite) {
					sprite.lastDirection = 1;
					sprite.yDirection = 1;
					//sprite.walkingDown.next();
					if(sprite.canRun) {
						if(sprite.yv < sprite.maxYv) {
							sprite.addVelocity(0, sprite.yInc);
						}
					}
					else {
						sprite.yv = Math.abs(sprite.constYv);
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to move randomly                                          //
				//////////////////////////////////////////////////////////////////
				_moveRandomly = function(sprite) {
					var rand = Math.floor(Math.random()*4);
					if(rand == 0) {
						if(sprite.canVertical) {
							_moveUp(sprite);
						}
					}
					else if(rand == 1) {
						if(sprite.canVertical) {
							_moveDown(sprite);
						}
					}
					else if(rand == 2) {
						_moveLeft(sprite);
					}
					else {
						_moveRight(sprite);
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to jump up                                                //
				//////////////////////////////////////////////////////////////////
				_jumpUp = function(sprite) {
					if(!(this.canVertical)) {
						if(sprite.selected && sprite.hasLanded) {
							sprite.hasLanded = false;
							sprite.setVelocity(sprite.xv, sprite.jumpVelocity);
						}
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to apply friction                                         //
				//////////////////////////////////////////////////////////////////
				_applyFriction = function(sprite, plane) {
					if(plane == 0) {
						//Plane 0 for horizontal friction
						if(sprite.xDirection == 2) {
							if(sprite.xv < 0) {
								if(sprite.canRoll) {
									if(sprite.rv > 0) {
										sprite.rv = sprite.rv + 0.01;
									}
									sprite.rotate(sprite.rv);
								}
								sprite.walkingLeft.next();
								sprite.addVelocity(sprite.xFriction, 0);
							}
							else {
								sprite.setVelocity(0, sprite.yv);
								sprite.rv = 0;
							}
						}
						else if(sprite.xDirection == 3) {
							if(sprite.xv > 0) {
								if(sprite.canRoll) {
									if(sprite.rv < 0) {
										sprite.rv = sprite.rv - 0.01;
									}
									sprite.rotate(sprite.rv);
								}
								sprite.walkingRight.next();
								sprite.addVelocity(sprite.xFriction * -1, 0);
							}
							else {
								sprite.setVelocity(0, sprite.yv);
								sprite.rv = 0;
							}
						}
					}
					
					if(plane == 1) {
						//Plane 1 for vertical friction
						if(sprite.yDirection == 0) {
							if(sprite.yv < 0) {
								sprite.walkingLeft.next();
								sprite.addVelocity(0, sprite.yFriction);
							}
							else {
								sprite.setVelocity(sprite.xv, 0);
							}
						}
						else if(sprite.yDirection == 1) {
							if(sprite.yv > 0) {
								sprite.walkingRight.next();
								sprite.addVelocity(0, sprite.yFriction * -1);
							}
							else {
								sprite.setVelocity(sprite.xv, 0);
							}
						}
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to apply gravity                                          //
				//////////////////////////////////////////////////////////////////
				_applyGravity = function(sprite) {
					if(!(sprite.hasLanded)) {
						sprite.addVelocity(0, that.gravity);
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//How to fix out of bounds and update position                  //
				//////////////////////////////////////////////////////////////////
				_fixBounds = function(sprite) {
					if((sprite.xv < 0) && (sprite.x + sprite.xv) < 0) {
						sprite.setVelocity(0, sprite.yv);
						sprite.setX(0);
					}
					else if((sprite.xv > 0) && (((sprite.x + sprite.xv) + sprite.w) > sprite.layer.w)) {
						sprite.setVelocity(0, sprite.yv);
						sprite.setX(sprite.layer.w - sprite.w);
					}
					else{
						sprite.setX(sprite.x + sprite.xv);
						if(!(sprite.canRun)) {
							sprite.setVelocity(0, sprite.yv);
						}
					}
					
					if((sprite.yv < 0) && ((sprite.y + sprite.yv) < 0)) {
						sprite.setVelocity(sprite.xv, 0);
						sprite.setY(0);
					}
					else if((sprite.yv > 0) && (((sprite.y + sprite.yv) + sprite.h) > sprite.layer.h)) {
						sprite.hasLanded = true;
						sprite.setVelocity(sprite.xv, 0);
						sprite.setY(sprite.layer.h - sprite.h);
					}
					else{
						sprite.setY(sprite.y + sprite.yv);
						if(sprite.canVertical) {
							if(!(sprite.canRun)) {
								sprite.setVelocity(sprite.xv, 0);
							}
						}
					}
				}
				
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				var s = layer.Sprite('img/test/star.png');
				s.move(0, 0);
				s.update();
				//////////////////////////////////////////////////////////////////
				//TESTTTTTTTTTTTT                                               //
				//////////////////////////////////////////////////////////////////
				
				//////////////////////////////////////////////////////////////////
				//How to handle mouse click                                     //
				//////////////////////////////////////////////////////////////////
				scene.dom.onclick = function(e) {
					if(sjs.collision.isPointInImage(
						e.clientX - s.x - scene.dom.offsetLeft,
						e.clientY - s.y - scene.dom.offsetTop,
						s.w,
						s.h,
						s.img)
					) {
						alert("star touched");
					}
					
					if(sjs.collision.isPointInImage(
						e.clientX - that.player.x - scene.dom.offsetLeft,
						e.clientY - that.player.y - scene.dom.offsetTop,
						that.player.w,
						that.player.h,
						that.player.img)
					) {
						that.player.selected = true;
						that.player2.selected = false;
					}
					
					if(sjs.collision.isPointInImage(
						e.clientX - that.player2.x - scene.dom.offsetLeft,
						e.clientY - that.player2.y - scene.dom.offsetTop,
						that.player2.w,
						that.player2.h,
						that.player2.img)
					) {
						that.player.selected = false;
						that.player2.selected = true;
					}
				};
				
				//////////////////////////////////////////////////////////////////
				//Create NPC                                                    //
				//////////////////////////////////////////////////////////////////
				_createNPC = function(img, x, y) {
					NPC = that.scene.Sprite(img, {
						"layer": that.layer,
						"x": x,
						"y": y,
						//"w": 64,
						//"h": 64,
						//"angle": 0,
						"xv": 0,
						"yv": 0,
						"friction": 0.5
					});
					
					//Common properties
					NPC.isNPC = true;
					NPC.lastDirection = 1; //2 - left, 3 - right, 0 - up, 1 - down
					NPC.xDirection = 3; //2 - left, 3 - right
					NPC.yDirection = 1; //0 - up, 1 - down
					NPC.canRun = false;
					NPC.canRoll = false;
					NPC.constXv = 2;
					NPC.constYv = 2;
					NPC.maxXv = 5;
					NPC.maxYv = 5;
					NPC.xInc = 0.5;
					NPC.yInc = 0.5;
					NPC.xFriction = 0.5;
					NPC.yFriction = 0.5;
					NPC.rollAng = 0;
					NPC.maxRollAng = 0.1;
					NPC.canVertical = false;
					NPC.hasLanded = false;
					NPC.jumpVelocity = -2;
					
					NPC.standingLeft = scene.Cycle([
						[0, 0, 5]
					]).addSprite(NPC);
					NPC.standingRight = scene.Cycle([
						[0, 0, 5]
					]).addSprite(NPC);
					NPC.walkingLeft = scene.Cycle([
						[0, 0, 5],
						[64, 64, 5]
					]).addSprite(NPC);
					NPC.walkingRight = scene.Cycle([
						[0, 0, 5],
						[64, 64, 5]
					]).addSprite(NPC);
					
					NPC.move = function() {
						_moveRandomly(this);
					}
					
					that.spriteList.push(this.NPC);
				}
				
				_createNPC('img/BIG_BUNNY.png', 200, 100);
				
				//////////////////////////////////////////////////////////////////
				//Create run method which will be called each time the          //
				//game loop runs                                                //
				//////////////////////////////////////////////////////////////////
				this.run = function() {
					//Update and Paint all images
					for (var i in that.spriteList) {
						_updateMovement(that.spriteList[i]);
						
						_fixBounds(that.spriteList[i]);
						
						that.spriteList[i].update();
					}
				}
			}
	</script>
	</head>
	<body>
		Click on the bunny and press wasd or arrows
		<span id="debug"></span>
	</body>
</html>